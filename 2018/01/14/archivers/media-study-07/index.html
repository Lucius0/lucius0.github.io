<!doctype html>




<html class="theme-next mist" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="media," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="初次学习有关音视频这一块的开发，主要是基于 flv.js 的学习。这一块的知识概念实在是太多太深了，所以本人是先在本地做记录，后面会整理慢慢地上传与各位分享，假如有地方说错，请勘误。谢谢指点。 概述MP4(MPEG-4 Part 14)是一种常见的多媒体容器格式，它是在“ISO/IEC 14496-14”标准文件中定义的，属于MPEG-4的一部分，是“ISO/IEC 14496-12(MPEG-4">
<meta name="keywords" content="media">
<meta property="og:type" content="article">
<meta property="og:title" content="音视频学习-FMP4结构之MP4">
<meta property="og:url" content="https://lucius0.github.io/2018/01/14//archivers/media-study-07/index.html">
<meta property="og:site_name" content="Lucius&#39;s Blog">
<meta property="og:description" content="初次学习有关音视频这一块的开发，主要是基于 flv.js 的学习。这一块的知识概念实在是太多太深了，所以本人是先在本地做记录，后面会整理慢慢地上传与各位分享，假如有地方说错，请勘误。谢谢指点。 概述MP4(MPEG-4 Part 14)是一种常见的多媒体容器格式，它是在“ISO/IEC 14496-14”标准文件中定义的，属于MPEG-4的一部分，是“ISO/IEC 14496-12(MPEG-4">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://lucius0.github.io/images/qiniu/180114225134.png">
<meta property="og:image" content="https://lucius0.github.io/images/qiniu/180114225303.png">
<meta property="og:image" content="https://lucius0.github.io/images/qiniu/180114231843.png">
<meta property="og:image" content="https://lucius0.github.io/images/qiniu/180114231904.png">
<meta property="og:image" content="https://lucius0.github.io/images/qiniu/180114231922.png">
<meta property="og:image" content="https://lucius0.github.io/images/qiniu/180114232102.png">
<meta property="og:image" content="https://lucius0.github.io/images/qiniu/180114232325.png">
<meta property="og:image" content="https://lucius0.github.io/images/qiniu/180114232505.png">
<meta property="og:image" content="https://lucius0.github.io/images/qiniu/180114232522.png">
<meta property="og:image" content="https://lucius0.github.io/images/qiniu/180114232618.png">
<meta property="og:updated_time" content="2019-01-05T03:45:10.492Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="音视频学习-FMP4结构之MP4">
<meta name="twitter:description" content="初次学习有关音视频这一块的开发，主要是基于 flv.js 的学习。这一块的知识概念实在是太多太深了，所以本人是先在本地做记录，后面会整理慢慢地上传与各位分享，假如有地方说错，请勘误。谢谢指点。 概述MP4(MPEG-4 Part 14)是一种常见的多媒体容器格式，它是在“ISO/IEC 14496-14”标准文件中定义的，属于MPEG-4的一部分，是“ISO/IEC 14496-12(MPEG-4">
<meta name="twitter:image" content="https://lucius0.github.io/images/qiniu/180114225134.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lucius0.github.io/2018/01/14//archivers/media-study-07/"/>





  <title> 音视频学习-FMP4结构之MP4 | Lucius's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Lucius's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            日志
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://lucius0.github.io/2018/01/14/archivers/media-study-07/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Lucius">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Lucius's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Lucius's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                音视频学习-FMP4结构之MP4
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-14T00:00:00+08:00">
                2018-01-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/media/" itemprop="url" rel="index">
                    <span itemprop="name">media</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>初次学习有关音视频这一块的开发，主要是基于 <strong><a href="https://github.com/Bilibili/flv.js" target="_blank" rel="noopener">flv.js</a></strong> 的学习。这一块的知识概念实在是太多太深了，所以本人是先在本地做记录，后面会整理慢慢地上传与各位分享，假如有地方说错，请勘误。谢谢指点。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>MP4(MPEG-4 Part 14)是一种常见的多媒体容器格式，它是在“ISO/IEC 14496-14”标准文件中定义的，属于MPEG-4的一部分，是“ISO/IEC 14496-12(MPEG-4 Part 12 ISO base media file format)”标准中所定义的媒体格式的一种实现，后者定义了一种通用的媒体文件结构标准。MP4是一种描述较为全面的容器格式，被认为可以在其中嵌入任何形式的数据，各种编码的视频、音频等都不在话下，不过我们常见的大部分的MP4文件存放的AVC(H.264)或MPEG-4(Part 2)编码的视频和AAC编码的音频。MP4格式的官方文件后缀名是“.mp4”，还有其他的以mp4为基础进行的扩展或者是缩水版本的格式，包括：M4V,  3GP, F4V等。</p>
<p>在HTML5播放器中，目前仅支持<strong>WebM</strong>和<strong>MPEG H.264 AAC</strong>的编码格式，而WebM的在浏览器的支持度没有mp4的支持度好。而fmp4区别于mp4，主要是因为可以通过fmp4的<code>moof+mdat</code>的格式结构，很好的在不同质量的码流做码率切换。</p>
<p>MP4是由一个个的Box组成的，也就是可以说Box是MP4的最小单元。官方文档可以查看：<a href="http://l.web.umkc.edu/lizhu/teaching/2016sp.video-communication/ref/mp4.pdf" target="_blank" rel="noopener">ISO_IEC_14496-12</a>。而Box的类型有太多太多了，可以自行查看文档中的<strong>Table 1 — Box types, structure, and cross-reference</strong>部分，这里我就不贴出来了。</p>
<h2 id="BOX"><a href="#BOX" class="headerlink" title="BOX"></a>BOX</h2><p>以下是fmp4跟mp4的结构图，可以很清楚的看到两者的区别。<br><img src="/images/qiniu/180114225134.png" alt=""></p>
<p>从官方文档看，可以知道，除了Box，还有一种Full Box。Box的结构图如下：<br><img src="/images/qiniu/180114225303.png" alt=""></p>
<p>Box的官方示例代码如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Box</span></span><br><span class="line"><span class="comment">// Box只会给Header(size、type)</span></span><br><span class="line">aligned(8) class Box (unsigned int(32) boxtype, optional unsigned int(8)[16] extended_type) &#123;</span><br><span class="line">   <span class="comment">// Box大小，包括Header，所以上面的ftyp中size为8+24</span></span><br><span class="line">   <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> size</span>;</span><br><span class="line">   <span class="comment">// ftyp，就是type，一般都是4个字母，所以通过charCodeAt获取即可。</span></span><br><span class="line">   <span class="comment">// flv.js中的代码片段实现如下。</span></span><br><span class="line">   <span class="comment">// MP4.types[name] = [</span></span><br><span class="line">   <span class="comment">//   name.charCodeAt(0),</span></span><br><span class="line">   <span class="comment">//   name.charCodeAt(1),</span></span><br><span class="line">   <span class="comment">//   name.charCodeAt(2),</span></span><br><span class="line">   <span class="comment">//   name.charCodeAt(3)</span></span><br><span class="line">   <span class="comment">// ];</span></span><br><span class="line">   <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> type </span>= boxtype;</span><br><span class="line">   <span class="keyword">if</span> (size==<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span> largesize</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size==<span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// box extends to end of file</span></span><br><span class="line">   &#125;</span><br><span class="line">  <span class="comment">// 用户扩展使用扩展类型，在这种情况下，类型字段设置为“uuid”，不过几乎没遇过</span></span><br><span class="line">  <span class="keyword">if</span> (boxtype==‘uuid’) &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>(<span class="number">8</span>)[<span class="number">16</span>] usertype = extended_type;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FullBox，增加了version以及flags，不难理解，是Box的扩展。FullBox是没有子box的。</span></span><br><span class="line">aligned(8) class FullBox(unsigned int(32) boxtype, unsigned int(8) v, bit(24) f) extends Box(boxtype) &#123;</span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">8</span>)</span> version </span>= v; <span class="comment">//</span></span><br><span class="line">  bit(<span class="number">24</span>) flags = f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在<code>mp4-generator.js</code>中，生成box的代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generate a box</span></span><br><span class="line"><span class="keyword">static</span> box(type) &#123;</span><br><span class="line">  <span class="keyword">let</span> size = <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">let</span> datas = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">let</span> arrayCount = datas.length;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arrayCount; i++) &#123;</span><br><span class="line">    size += datas[i].byteLength;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  result = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(size);</span><br><span class="line">  result[<span class="number">0</span>] = (size &gt;&gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>;  <span class="comment">// size</span></span><br><span class="line">  result[<span class="number">1</span>] = (size &gt;&gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  result[<span class="number">2</span>] = (size &gt;&gt;&gt;  <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">  result[<span class="number">3</span>] = (size) &amp; <span class="number">0xFF</span>;</span><br><span class="line"></span><br><span class="line">  result.set(type, <span class="number">4</span>);  <span class="comment">// type</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> offset = <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arrayCount; i++) &#123;  <span class="comment">// data body</span></span><br><span class="line">    result.set(datas[i], offset);</span><br><span class="line">    offset += datas[i].byteLength;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成 ftyp box</span></span><br><span class="line"><span class="keyword">let</span> ftyp = MP4.box(MP4.types.ftyp, MP4.constants.FTYP);</span><br></pre></td></tr></table></figure></p>
<h2 id="FTYP"><a href="#FTYP" class="headerlink" title="FTYP"></a>FTYP</h2><p>File Type Box<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class FileTypeBox extends <span class="title">Box</span><span class="params">(‘ftyp’)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 主要推荐版本</span></span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> major_brand</span>;</span><br><span class="line">  <span class="comment">// 最低兼容版本</span></span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> minor_version</span>;</span><br><span class="line">  <span class="comment">// 兼容版本</span></span><br><span class="line">  unsigned int(32) compatible_brands[]; // to end of the box</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例格式</span></span><br><span class="line">[ftyp] size=<span class="number">8</span>+<span class="number">16</span></span><br><span class="line">  major_brand = qt  </span><br><span class="line">  minor_version = <span class="number">0</span></span><br><span class="line">  compatible_brand = qt  </span><br><span class="line">  compatible_brand = iso5</span><br></pre></td></tr></table></figure></p>
<h2 id="MOOV"><a href="#MOOV" class="headerlink" title="MOOV"></a>MOOV</h2><p>Movie Box，继承box，那么就可以知道有4个字节，这4个字节是子box的长度。可以在上图看到，moov主要是为了存放trak、mvhd，fmp4还会存放mvex box。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="class"><span class="keyword">class</span> <span class="title">MovieBox</span> <span class="keyword">extends</span> <span class="title">Box</span>(‘<span class="title">moov</span>’)</span>&#123; &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-MVHD"><a href="#MOOV-MVHD" class="headerlink" title="MOOV::MVHD"></a>MOOV::MVHD</h3><p>Movie Header Box，该box有且只有一个，主要是记录整个容器的各种信息。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class MovieHeaderBox extends <span class="title">FullBox</span><span class="params">(‘mvhd’, version, <span class="number">0</span>)</span> </span>&#123; </span><br><span class="line">  <span class="comment">// MVHD 的版本号，默认 0</span></span><br><span class="line">  <span class="keyword">if</span> (version==<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span>  creation_time</span>;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span>  modification_time</span>;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  timescale</span>;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span>  duration</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// version==0</span></span><br><span class="line">    <span class="comment">// 创建时间，从1904开始，整数，单位s</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>(<span class="number">32</span>)  creation_time;</span><br><span class="line">    <span class="comment">// 最近修改时间，同样从1904开始，整数，单位s</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  modification_time</span>;</span><br><span class="line">    <span class="comment">// 文件媒体在 1s 时间内的刻度值，可以理解为 1s 长度的时间单元数，一般情况下视频都是1000</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  timescale</span>;</span><br><span class="line">    <span class="comment">// 持续时间，一般来说电影时间 = duration / timescale</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  duration</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 播放速率，一般为 1，高16和低16分别表示小数点前后整数部分和小数部分</span></span><br><span class="line"><span class="function"><span class="keyword">template</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> rate </span>= <span class="number">0x00010000</span>; <span class="comment">// typically 1.0</span></span><br><span class="line"><span class="comment">// 音量，最大为100，高8位和低8位分别表示小数点前后整数和小数部分</span></span><br><span class="line"><span class="function"><span class="keyword">template</span> <span class="title">int</span><span class="params">(<span class="number">16</span>)</span> volume </span>= <span class="number">0x0100</span>; <span class="comment">// typically, full volume</span></span><br><span class="line"><span class="comment">// 保留字</span></span><br><span class="line"><span class="function"><span class="keyword">const</span> <span class="title">bit</span><span class="params">(<span class="number">16</span>)</span> reserved </span>= <span class="number">0</span>; </span><br><span class="line">const unsigned int(32)[2] reserved = 0;</span><br><span class="line"><span class="comment">// 视频变化矩阵 Unity matrix</span></span><br><span class="line">template int(32)[9] matrix = &#123; </span><br><span class="line">  <span class="number">0x00010000</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">  <span class="number">0</span>,<span class="number">0x00010000</span>,<span class="number">0</span>,</span><br><span class="line">  <span class="number">0</span>,<span class="number">0</span>,<span class="number">0x40000000</span></span><br><span class="line">&#125;;</span><br><span class="line">bit(<span class="number">32</span>)[<span class="number">6</span>]  pre_defined = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 下一个 track 使用的id 号</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  next_track_ID</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例格式</span></span><br><span class="line">[mvhd] size=<span class="number">12</span>+<span class="number">96</span></span><br><span class="line">  timescale = <span class="number">1000</span></span><br><span class="line">  duration = <span class="number">51952</span></span><br><span class="line">  duration(ms) = <span class="number">51952</span></span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK"><a href="#MOOV-TRAK" class="headerlink" title="MOOV::TRAK"></a>MOOV::TRAK</h3><p>Track Box，主要是存一个或多个media box的。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aligned(<span class="number">8</span>) <span class="function">class TrackBox extends <span class="title">Box</span><span class="params">(‘trak’)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-TKHD"><a href="#MOOV-TRAK-TKHD" class="headerlink" title="MOOV::TRAK::TKHD"></a>MOOV::TRAK::TKHD</h3><p>Track Header Box，trak box 的第一个box，主要是记录以下信息（一开始我还以为与上面的冲突了）。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class TrackHeaderBox extends <span class="title">FullBox</span><span class="params">(‘tkhd’, version, flags)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (version==<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span> creation_time</span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span> modification_time</span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> track_ID</span>;</span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> reserved </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span> duration</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// version==0</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>(<span class="number">32</span>) creation_time;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> modification_time</span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> track_ID</span>; <span class="comment">// 当前track的ID</span></span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> reserved </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> duration</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  const unsigned int(32)[2] reserved = 0;</span><br><span class="line">  <span class="comment">// 视频track的前后排序，类似photoshop中图层的概念，数值小的在播放时更贴近用户，0为默认值</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span> <span class="title">int</span><span class="params">(<span class="number">16</span>)</span> layer </span>= <span class="number">0</span>; </span><br><span class="line">  <span class="comment">// 备用分组ID，0表示无备用。否则该 track 可能会有零到多个备份track。当播放时相同group ID的track只选择一个进行播放。</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span> <span class="title">int</span><span class="params">(<span class="number">16</span>)</span> alternate_group </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 音量</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span> <span class="title">int</span><span class="params">(<span class="number">16</span>)</span> volume </span>= &#123;<span class="keyword">if</span> track_is_audio <span class="number">0x0100</span> <span class="keyword">else</span> <span class="number">0</span>&#125;;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">16</span>)</span> reserved </span>= <span class="number">0</span>;</span><br><span class="line">  template int(32)[9] matrix=&#123; </span><br><span class="line">    <span class="number">0x00010000</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">0x00010000</span>,<span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">0</span>,<span class="number">0x40000000</span> </span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// unity matrix</span></span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> width</span>;  <span class="comment">// 宽</span></span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> height</span>; <span class="comment">// 高</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例格式</span></span><br><span class="line">[tkhd] size=<span class="number">12</span>+<span class="number">80</span>, flags=<span class="number">7</span></span><br><span class="line">  enabled = <span class="number">1</span></span><br><span class="line">  id = <span class="number">1</span></span><br><span class="line">  duration = <span class="number">51952</span></span><br><span class="line">  width = <span class="number">856.000000</span></span><br><span class="line">  height = <span class="number">720.000000</span></span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-EDTS"><a href="#MOOV-TRAK-EDTS" class="headerlink" title="MOOV::TRAK::EDTS"></a>MOOV::TRAK::EDTS</h3><p>Edit Box，不是必要的，主要是将时间线映射到media时间线上，是Edit List Box的容器。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class EditBox extends <span class="title">Box</span><span class="params">(‘edts’)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-EDTS-ELST"><a href="#MOOV-TRAK-EDTS-ELST" class="headerlink" title="MOOV::TRAK::EDTS::ELST"></a>MOOV::TRAK::EDTS::ELST</h3><p>Edit List Box，不是必要的，主要是保存切确的时间表，使得某个track的时间戳产生偏移，能达到延迟播放的作用。<a href="http://blog.jianchihu.net/mp4-elst-box.html" target="_blank" rel="noopener">mp4文件elst研究</a><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class EditListBox extends <span class="title">FullBox</span><span class="params">(‘elst’, version, <span class="number">0</span>)</span> </span>&#123; </span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> entry_count</span>;</span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">1</span>; i &lt;= entry_count; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (version==<span class="number">1</span>) &#123;</span><br><span class="line">       <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span> segment_duration</span>;</span><br><span class="line">       <span class="keyword">int</span>(<span class="number">64</span>) media_time;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// version==0</span></span><br><span class="line">       <span class="comment">// 表该box的时长，以Movie Header Box中的timescale为单位。</span></span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span>(<span class="number">32</span>) segment_duration;</span><br><span class="line">       <span class="comment">// 该box的起始时间，以 track 中Media Header Box中的timescale 为单位。如果值为-1，表示是空edit box，一个 track 中最后一个 edit 不能为空。</span></span><br><span class="line">       <span class="keyword">int</span>(<span class="number">32</span>)  media_time;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 速率。为0的话，相当于'dwell'，即画面停止。</span></span><br><span class="line">    <span class="keyword">int</span>(<span class="number">16</span>) media_rate_integer;</span><br><span class="line">    <span class="keyword">int</span>(<span class="number">16</span>) media_rate_fraction = <span class="number">0</span>;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA"><a href="#MOOV-TRAK-MDIA" class="headerlink" title="MOOV::TRAK::MDIA"></a>MOOV::TRAK::MDIA</h3><p>Media Box，保存媒体信息的容器。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class MediaBox extends <span class="title">Box</span><span class="params">(‘mdia’)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-MDHD"><a href="#MOOV-TRAK-MDIA-MDHD" class="headerlink" title="MOOV::TRAK::MDIA::MDHD"></a>MOOV::TRAK::MDIA::MDHD</h3><p>Media Header Box，存放媒体信息。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class MediaHeaderBox extends <span class="title">FullBox</span><span class="params">(‘mdhd’, version, <span class="number">0</span>)</span> </span>&#123; </span><br><span class="line">  <span class="keyword">if</span> (version==<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span>  creation_time</span>;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span>  modification_time</span>;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  timescale</span>;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span>  duration</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123; <span class="comment">// version==0</span></span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">int</span>(<span class="number">32</span>)  creation_time;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  modification_time</span>;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  timescale</span>;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  duration</span>;</span><br><span class="line">&#125;</span><br><span class="line">  bit(<span class="number">1</span>) pad = <span class="number">0</span>;</span><br><span class="line">  unsigned int(5)[3] language; // ISO-639-2/T language code</span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">16</span>)</span> pre_defined </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例格式</span></span><br><span class="line">[mdia] size=<span class="number">8</span>+<span class="number">415</span></span><br><span class="line">  [mdhd] size=<span class="number">12</span>+<span class="number">20</span></span><br><span class="line">    timescale = <span class="number">600</span></span><br><span class="line">    duration = <span class="number">0</span></span><br><span class="line">    duration(ms) = <span class="number">0</span></span><br><span class="line">    language = und</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-HDLR"><a href="#MOOV-TRAK-MDIA-HDLR" class="headerlink" title="MOOV::TRAK::MDIA::HDLR"></a>MOOV::TRAK::MDIA::HDLR</h3><p>Handler Reference Box，主要是用来跟踪中媒体数据被呈现的过程。例如，video track将由video handler box处理。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class HandlerBox extends <span class="title">FullBox</span><span class="params">(‘hdlr’, version = <span class="number">0</span>, <span class="number">0</span>)</span> </span>&#123; </span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> pre_defined </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// hanler type有以下几种格式：</span></span><br><span class="line">  <span class="comment">// ‘vide’ Video track</span></span><br><span class="line">  <span class="comment">// ‘soun’ Audio track</span></span><br><span class="line">  <span class="comment">// ‘hint’ Hint track</span></span><br><span class="line">  <span class="comment">// ‘meta’ Timed Metadata track</span></span><br><span class="line">  <span class="comment">// ‘auxv’ Auxiliary Video track</span></span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> handler_type</span>;</span><br><span class="line">  const unsigned int(32)[3] reserved = 0;</span><br><span class="line">  <span class="built_in">string</span> name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例格式</span></span><br><span class="line">[hdlr] size=<span class="number">12</span>+<span class="number">41</span></span><br><span class="line">  handler_type = vide</span><br><span class="line">  handler_name = Bento4 Video Handler</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-MINF"><a href="#MOOV-TRAK-MDIA-MINF" class="headerlink" title="MOOV::TRAK::MDIA::MINF"></a>MOOV::TRAK::MDIA::MINF</h3><p>Media Information Box。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aligned(<span class="number">8</span>) <span class="function">class MediaInformationBox extends <span class="title">Box</span><span class="params">(‘minf’)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-VMHD-SMHD-HMHD-NMHD"><a href="#MOOV-TRAK-MDIA-VMHD-SMHD-HMHD-NMHD" class="headerlink" title="MOOV::TRAK::MDIA::VMHD/SMHD/HMHD/NMHD"></a>MOOV::TRAK::MDIA::VMHD/SMHD/HMHD/NMHD</h3><p>Media Information Header Boxes。每种音轨类型都有不同的媒体信息头（对应media handler-type）; 匹配的头文件应该存在，可以是这里定义的头文件之一，或者派生的规范中定义的头文件之一。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="class"><span class="keyword">class</span> <span class="title">VideoMediaHeaderBox</span></span></span><br><span class="line"><span class="class"><span class="title">extends</span> <span class="title">FullBox</span>(‘<span class="title">vmhd</span>’, <span class="title">version</span> = 0, 1) &#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">template</span> <span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">16</span>)</span> graphicsmode </span>= <span class="number">0</span>; <span class="comment">// copy, see below </span></span><br><span class="line">  template unsigned int(16)[3] opcolor = &#123;0, 0, 0&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">aligned(<span class="number">8</span>) <span class="class"><span class="keyword">class</span> <span class="title">SoundMediaHeaderBox</span></span></span><br><span class="line"><span class="class">   <span class="title">extends</span> <span class="title">FullBox</span>(‘<span class="title">smhd</span>’, <span class="title">version</span> = 0, 0) &#123;</span></span><br><span class="line">   <span class="function"><span class="keyword">template</span> <span class="title">int</span><span class="params">(<span class="number">16</span>)</span> balance </span>= <span class="number">0</span>;</span><br><span class="line">   <span class="function"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">16</span>)</span>  reserved </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例格式</span></span><br><span class="line">[vmhd] size=<span class="number">12</span>+<span class="number">8</span>, flags=<span class="number">1</span></span><br><span class="line">  graphics_mode = <span class="number">0</span></span><br><span class="line">  op_color = <span class="number">0000</span>,<span class="number">0000</span>,<span class="number">0000</span></span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-MINF-DINF"><a href="#MOOV-TRAK-MDIA-MINF-DINF" class="headerlink" title="MOOV::TRAK::MDIA::MINF::DINF"></a>MOOV::TRAK::MDIA::MINF::DINF</h3><p>Data Information Box。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class DataInformationBox extends <span class="title">Box</span><span class="params">(‘dinf’)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-MINF-DINF-DREF"><a href="#MOOV-TRAK-MDIA-MINF-DINF-DREF" class="headerlink" title="MOOV::TRAK::MDIA::MINF::DINF::DREF"></a>MOOV::TRAK::MDIA::MINF::DINF::DREF</h3><p>Data Reference Box。有三种子box类型，‘url ‘, ‘urn ‘, ‘dref’。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="class"><span class="keyword">class</span> <span class="title">DataReferenceBox</span></span></span><br><span class="line"><span class="class">   <span class="title">extends</span> <span class="title">FullBox</span>(‘<span class="title">dref</span>’, <span class="title">version</span> = 0, 0) &#123;</span></span><br><span class="line">   <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  entry_count</span>;</span><br><span class="line">   <span class="keyword">for</span> (i=<span class="number">1</span>; i &lt;= entry_count; i++) &#123;</span><br><span class="line">    <span class="comment">// URL box / URN box</span></span><br><span class="line">    <span class="comment">// entry_version：声明entry box格式的版本</span></span><br><span class="line">    <span class="comment">// entry_flags：标识，其中0x000001表示media box与包含此数据的引用的media box(moof)相同。</span></span><br><span class="line">    DataEntryBox(entry_version, entry_flags) data_entry; </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例格式</span></span><br><span class="line">[dinf] size=<span class="number">8</span>+<span class="number">28</span></span><br><span class="line">  [dref] size=<span class="number">12</span>+<span class="number">16</span></span><br><span class="line">    [url] size=<span class="number">12</span>+<span class="number">0</span>, flags=<span class="number">1</span></span><br><span class="line">      location = [local to file]</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-MINF-DINF-DREF-URL-URN"><a href="#MOOV-TRAK-MDIA-MINF-DINF-DREF-URL-URN" class="headerlink" title="MOOV::TRAK::MDIA::MINF::DINF::DREF::URL/URN"></a>MOOV::TRAK::MDIA::MINF::DINF::DREF::URL/URN</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(8) class DataEntryUrlBox (bit(24) flags) extends FullBox(‘url ’, version = 0, flags) &#123; </span><br><span class="line">  <span class="built_in">string</span> location;</span><br><span class="line">&#125;</span><br><span class="line">aligned(8) class DataEntryUrnBox (bit(24) flags) extends FullBox(‘urn ’, version = 0, flags) &#123; </span><br><span class="line">  <span class="built_in">string</span> name;</span><br><span class="line">  <span class="built_in">string</span> location;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MOOV-TRAK-MDIA-MINF-STBL"><a href="#MOOV-TRAK-MDIA-MINF-STBL" class="headerlink" title="MOOV::TRAK::MDIA::MINF::STBL"></a>MOOV::TRAK::MDIA::MINF::STBL</h3><p>Sample Table Box。由图可以看出，是作为一个容器存在。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aligned(<span class="number">8</span>) <span class="function">class SampleTableBox extends <span class="title">Box</span><span class="params">(‘stbl’)</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-MINF-STBL-STSD"><a href="#MOOV-TRAK-MDIA-MINF-STBL-STSD" class="headerlink" title="MOOV::TRAK::MDIA::MINF::STBL::STSD"></a>MOOV::TRAK::MDIA::MINF::STBL::STSD</h3><p>Sample Description Box。 box header和version字段后会有一个entry count字段，根据entry的个数，每个entry会有type信息，如“vide”、“sund”等，根据type不同sample description会提供不同的信息，例如对于video track，会有“VisualSampleEntry”类型信息，对于audio track会有“AudioSampleEntry”类型信息。<br>视频的编码类型、宽高、长度，音频的声道、采样等信息都会出现在这个box中。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(8) class SampleDescriptionBox (unsigned int(32) handler_type) extends FullBox('stsd', 0, 0) &#123;</span><br><span class="line">  <span class="keyword">int</span> i ;</span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> entry_count</span>;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span> ; i &lt;= entry_count ; i++) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (handler_type) &#123;</span><br><span class="line">      <span class="keyword">case</span> ‘soun’: <span class="comment">// for audio tracks</span></span><br><span class="line">        AudioSampleEntry();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> ‘vide’: <span class="comment">// for video tracks</span></span><br><span class="line">        VisualSampleEntry();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> ‘hint’: <span class="comment">// Hint track</span></span><br><span class="line">              HintSampleEntry();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> ‘meta’: <span class="comment">// Metadata track</span></span><br><span class="line">              MetadataSampleEntry();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">       &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例格式</span></span><br><span class="line">[stbl] size=<span class="number">8</span>+<span class="number">258</span></span><br><span class="line">  [stsd] size=<span class="number">12</span>+<span class="number">178</span></span><br><span class="line">    entry-count = <span class="number">1</span></span><br><span class="line">    [avc1] size=<span class="number">8</span>+<span class="number">166</span></span><br><span class="line">      data_reference_index = <span class="number">1</span></span><br><span class="line">      width = <span class="number">856</span></span><br><span class="line">      height = <span class="number">720</span></span><br><span class="line">      compressor = H<span class="number">.264</span></span><br><span class="line">      [avcC] size=<span class="number">8</span>+<span class="number">46</span></span><br><span class="line">        Configuration Version = <span class="number">1</span></span><br><span class="line">        Profile = Main</span><br><span class="line">        Profile Compatibility = <span class="number">0</span></span><br><span class="line">        Level = <span class="number">31</span></span><br><span class="line">        NALU Length Size = <span class="number">4</span></span><br><span class="line">        Sequence Parameter = [<span class="number">27</span> <span class="number">4</span>d <span class="number">00</span> <span class="number">1f</span> <span class="number">89</span> <span class="number">8b</span> <span class="number">60</span> <span class="number">6</span>c <span class="number">0b</span> <span class="number">7</span>c be <span class="number">02</span> d4 <span class="number">04</span> <span class="number">04</span> <span class="number">04</span> c0 c0 <span class="number">01</span> <span class="number">77</span> <span class="number">00</span> <span class="number">00</span> <span class="number">5</span>d c1 <span class="number">7b</span> df <span class="number">07</span> c2 <span class="number">21</span> <span class="number">1b</span> <span class="number">80</span>]</span><br><span class="line">        Picture Parameter = [<span class="number">28</span> ee <span class="number">1f</span> <span class="number">20</span>]</span><br><span class="line">      [colr] size=<span class="number">8</span>+<span class="number">10</span></span><br><span class="line">      [pasp] size=<span class="number">8</span>+<span class="number">8</span></span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-MINF-STBL-STTS"><a href="#MOOV-TRAK-MDIA-MINF-STBL-STTS" class="headerlink" title="MOOV::TRAK::MDIA::MINF::STBL::STTS"></a>MOOV::TRAK::MDIA::MINF::STBL::STTS</h3><p>Decoding Time to Sample Box。存储了sample的duration，描述了sample时序的映射方法，我们通过它可以找到任何时间的sample。“stts”可以包含一个压缩的表来映射时间和sample序号，用其他的表来提供每个sample的长度和指针。表中每个条目提供了在同一个时间偏移量里面连续的sample序号，以及samples的偏移量。递增这些偏移量，就可以建立一个完整的time to sample表。<br>每个sample的显示时间可以通过如下的公式得到：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D(n+<span class="number">1</span>) = D(n) + STTS(n)</span><br></pre></td></tr></table></figure></p>
<p>其中，STTS(n)是sample n的时间间隔，包含在表格中；D(n)是sample n的显示时间。<br><img src="/images/qiniu/180114231843.png" alt=""><br>因此有DT(2) = DT(1) + STTS(1)，其中STTS就是Decode delta(1)=10。那么sample_count跟sample_delta的关系就是如下表：<br><img src="/images/qiniu/180114231904.png" alt=""><br>那么entry_count是什么？假如这个媒体流存在9个samples，这里的entry和chunk不是对应的。sample 4、5和6在同一个chunk中，但是，由于他们的时长不一样，sample 4的时长为3，而sample 5和6的时长为1，因此，通过不同的entry来描述。<br><img src="/images/qiniu/180114231922.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="class"><span class="keyword">class</span> <span class="title">TimeToSampleBox</span></span></span><br><span class="line"><span class="class">   <span class="title">extends</span> <span class="title">FullBox</span>(’<span class="title">stts</span>’, <span class="title">version</span> = 0, 0) &#123;</span></span><br><span class="line">   <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  entry_count</span>;</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line">   <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; entry_count; i++) &#123;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  sample_count</span>;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  sample_delta</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-MINF-STBL-CTTS"><a href="#MOOV-TRAK-MDIA-MINF-STBL-CTTS" class="headerlink" title="MOOV::TRAK::MDIA::MINF::STBL::CTTS"></a>MOOV::TRAK::MDIA::MINF::STBL::CTTS</h3><p>Composition Time to Sample Box。每一个视频sample都有一个解码顺序和一个显示顺序。对于一个sample来说，解码顺序和显示顺序可能不一致，比如H.264格式，因此，CTTS就是在这种情况下被使用的。</p>
<ol>
<li>如果解码顺序和显示顺序是一致的，CTTS就不会出现。STTS既提供了解码顺序也提供了显示顺序，并能够计算出每个sample的开始时间和结束时间。</li>
<li>如果解码顺序和显示顺序不一致，那么STTS既提供解码顺序，CTTS则通过差值的形式来提供显示时间。<br>依旧看<strong>Table 2</strong>，那么sample_count跟sample_offset的关系如下：<br><img src="/images/qiniu/180114232102.png" alt=""><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class CompositionOffsetBox extends <span class="title">FullBox</span><span class="params">(‘ctts’, version = <span class="number">0</span>, <span class="number">0</span>)</span> </span>&#123; </span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> entry_count</span>;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">if</span> (version==<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; entry_count; i++) &#123;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  sample_count</span>;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  sample_offset</span>;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (version == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; entry_count; i++) &#123;</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">int</span>(<span class="number">32</span>)  sample_count;</span><br><span class="line">      <span class="function"><span class="keyword">signed</span>   <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  sample_offset</span>;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="MOOV-TRAK-MDIA-MINF-STBL-STCO"><a href="#MOOV-TRAK-MDIA-MINF-STBL-STCO" class="headerlink" title="MOOV::TRAK::MDIA::MINF::STBL::STCO"></a>MOOV::TRAK::MDIA::MINF::STBL::STCO</h3><p>Chunk Offset Box。Chunk的偏移量表，指定了每个chunk在文件中的位置。如下图：<br><img src="/images/qiniu/180114232325.png" alt=""><br>需要注意的是，box中只是给出了每个chunk的偏移量，并没有给出每个sample的偏移量。因此，如果要获得每个sample的偏移量，还需要用到Sample Size Box和Sample-To-Chunk Box。</p>
<p>stco 有两种形式，如果你的视频过大的话，就有可能造成 chunkoffset 超过 32bit 的限制。所以，这里针对大 Video 额外创建了一个 co64 的 Box。它的功效等价于 stco，也是用来表示 sample 在 mdat box 中的位置。只是，里面 chunk_offset 是 64bit 的。基本格式为：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line"><span class="comment">// 32位</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="class"><span class="keyword">class</span> <span class="title">ChunkOffsetBox</span></span></span><br><span class="line"><span class="class"><span class="title">extends</span> <span class="title">FullBox</span>(‘<span class="title">stco</span>’, <span class="title">version</span> = 0, 0) &#123;</span> </span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> entry_count</span>;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">1</span>; i u entry_count; i++) &#123;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  chunk_offset</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 64位</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class ChunkLargeOffsetBox extends <span class="title">FullBox</span><span class="params">(‘co64’, version = <span class="number">0</span>, <span class="number">0</span>)</span> </span>&#123; </span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> entry_count</span>;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">1</span>; i u entry_count; i++) &#123;</span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">64</span>)</span>  chunk_offset</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="MOOV-TRAK-MDIA-MINF-STBL-STSC"><a href="#MOOV-TRAK-MDIA-MINF-STBL-STSC" class="headerlink" title="MOOV::TRAK::MDIA::MINF::STBL::STSC"></a>MOOV::TRAK::MDIA::MINF::STBL::STSC</h3><p>Sample To Chunk Box。用chunk组织sample可以方便优化数据获取，一个chunk包含一个或多个sample。“stsc”中用一个表描述了sample与chunk的映射关系，查看这张表就可以找到包含指定sample的thunk，从而找到这个sample，当然每个table entry可能包含一个或者多个chunk。以下是table entry布局。<br><img src="/images/qiniu/180114232505.png" alt=""><br>每个table entry包含一组chunk，enrty中的每个chunk包含相同数目的sample。而且，这些chunk中的每个sample都必须使用相同的sample description。任何时候，如果chunk中的sample数目或者sample description改变，必须创建一个新的table entry。如果所有的chunk包含的sample数目相同，那么该table只有一个entry。<br>一个简单的例子，如图所示。图中看不出来总共有多少个chunk，因为entry中只包含第一个chunk号，因此，对于最后一个entry，在某些情况下需要特殊的处理，因为无法判断什么时候结束。<br><img src="/images/qiniu/180114232522.png" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="class"><span class="keyword">class</span> <span class="title">SampleToChunkBox</span></span></span><br><span class="line"><span class="class">   <span class="title">extends</span> <span class="title">FullBox</span>(‘<span class="title">stsc</span>’, <span class="title">version</span> = 0, 0) &#123;</span></span><br><span class="line">   <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  entry_count</span>;</span><br><span class="line">   <span class="keyword">for</span> (i=<span class="number">1</span>; i &lt;= entry_count; i++) &#123;</span><br><span class="line">    <span class="comment">// 每一个 entry 开始的 chunk 位置。</span></span><br><span class="line">        <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> first_chunk</span>;</span><br><span class="line">    <span class="comment">// 每一个 chunk 里面包含多少的 sample</span></span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> samples_per_chunk</span>; </span><br><span class="line">    <span class="comment">// 每一个 sample 的描述。一般可以默认设置为 1。</span></span><br><span class="line">      <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> sample_description_index</span>;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这 3 个字段实际上决定了一个 MP4 中有多少个 chunks，每个 chunks 有多少个 samples。这里顺便普及一下 chunk 和 sample 的相关概念。在 MP4 文件中，最小的基本单位是 Chunk 而不是 Sample。</p>
<ul>
<li>sample: 包含最小单元数据的 slice。里面有实际的 NAL 数据。</li>
<li>chunk: 里面包含的是一个一个的 sample。为了是优化数据的读取，让 I/O 更有效率。<br>前面说了，在 MP4 中最小的单位是 chunks，那么通过 stco 中定义的 chunk_offsets 字段，它描述的就是 chunks 在 mdat 中的位置。每一个 stco chunk_offset 就对应于某一个 index 的 chunks。那么，first_chunk 就是用来定义该 chunk entry 开始的位置。那这样的话，stsc 需要对每一个 chunk 进行定义吗？不需要，因为 stsc 是定义一整个 entry，即，如果他们的samples_per_chunk，sample_description_index 不变的话，那么后续的 chunks 都是用一样的模式。<br>即，如果你的 stsc 只有：<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">first_chunk: <span class="number">1</span></span><br><span class="line">samples_per_chunk: <span class="number">4</span></span><br><span class="line">sample_description_index: <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>也就是说，从第一个 chunk 开始，每通过切分 4 个 sample 划分为一个 chunk，并且每个 sample 的表述信息都是 1。它会按照这样划分方法一直持续到最后。当然，如果你的 sample 最后不能被 4 整除，最后的几段 sample 就会当做特例进行处理。<br>通常情况下，stsc 的值是不一样的：<br><img src="/images/qiniu/180114232618.png" alt=""><br>按照上面的情况就是，第 1 个 chunk 包含 2 个 samples。第 2-4 个 chunk 包含 1 个 sample，第 5 个 chunk 包含两个 chunk，第 6 个到最后一个 chunk 包含一个 sample。</p>
<h3 id="MOOV-TRAK-MDIA-MINF-STBL-STSZ"><a href="#MOOV-TRAK-MDIA-MINF-STBL-STSZ" class="headerlink" title="MOOV::TRAK::MDIA::MINF::STBL::STSZ"></a>MOOV::TRAK::MDIA::MINF::STBL::STSZ</h3><p>Sample Size Boxes。指定了每个sample的size。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方文档代码</span></span><br><span class="line">aligned(<span class="number">8</span>) <span class="function">class SampleSizeBox extends <span class="title">FullBox</span><span class="params">(‘stsz’, version = <span class="number">0</span>, <span class="number">0</span>)</span> </span>&#123; </span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> sample_size</span>;</span><br><span class="line">  <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span> sample_count</span>;</span><br><span class="line">  <span class="keyword">if</span> (sample_size==<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">1</span>; i &lt;= sample_count; i++) &#123;</span><br><span class="line">     <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span><span class="params">(<span class="number">32</span>)</span>  entry_size</span>;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里就是mp4的一个大致的结构，下一篇我会给出剩下的，也就是FMP4区别于MP4的结构部分。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://blog.csdn.net/yu_yuan_1314/article/details/9078287" target="_blank" rel="noopener">MOV及MP4文件格式中几个重要的Table</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>我只是试下能不能被赞赏😳</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="https://bbucket-1257297990.cos.ap-guangzhou.myqcloud.com/IMG_4838.jpg" alt="Lucius WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="https://bbucket-1257297990.cos.ap-guangzhou.myqcloud.com/171226222918.png" alt="Lucius Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>    
     
     
        <ul class="post-copyright">
          <li class="post-copyright-author">
              <strong>本文作者：</strong>Lucius
          </li>
          <li class="post-copyright-link">
            <strong>本文链接：</strong>
            <a href="/2018/01/14/archivers/media-study-07/" title="音视频学习-FMP4结构之MP4">2018/01/14//archivers/media-study-07/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明： </strong>
            本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！
          </li>
        </ul>
      
    </div>
    
    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/media/" rel="tag"># media</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/11/archivers/media-study-06/" rel="next" title="音视频学习-flv之VideoTag(2)">
                <i class="fa fa-chevron-left"></i> 音视频学习-flv之VideoTag(2)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/16/archivers/media-study-08/" rel="prev" title="音视频学习-FMP4结构之FMP4">
                音视频学习-FMP4结构之FMP4 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitalk-container"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Lucius" />
          <p class="site-author-name" itemprop="name">Lucius</p>
          <p class="site-description motion-element" itemprop="description">stay hungry, stay foolish...</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">55</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Lucius0" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BOX"><span class="nav-number">2.</span> <span class="nav-text">BOX</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FTYP"><span class="nav-number">3.</span> <span class="nav-text">FTYP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MOOV"><span class="nav-number">4.</span> <span class="nav-text">MOOV</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-MVHD"><span class="nav-number">4.1.</span> <span class="nav-text">MOOV::MVHD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK"><span class="nav-number">4.2.</span> <span class="nav-text">MOOV::TRAK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-TKHD"><span class="nav-number">4.3.</span> <span class="nav-text">MOOV::TRAK::TKHD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-EDTS"><span class="nav-number">4.4.</span> <span class="nav-text">MOOV::TRAK::EDTS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-EDTS-ELST"><span class="nav-number">4.5.</span> <span class="nav-text">MOOV::TRAK::EDTS::ELST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA"><span class="nav-number">4.6.</span> <span class="nav-text">MOOV::TRAK::MDIA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MDHD"><span class="nav-number">4.7.</span> <span class="nav-text">MOOV::TRAK::MDIA::MDHD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-HDLR"><span class="nav-number">4.8.</span> <span class="nav-text">MOOV::TRAK::MDIA::HDLR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF"><span class="nav-number">4.9.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-VMHD-SMHD-HMHD-NMHD"><span class="nav-number">4.10.</span> <span class="nav-text">MOOV::TRAK::MDIA::VMHD/SMHD/HMHD/NMHD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF-DINF"><span class="nav-number">4.11.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF::DINF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF-DINF-DREF"><span class="nav-number">4.12.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF::DINF::DREF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF-DINF-DREF-URL-URN"><span class="nav-number">4.13.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF::DINF::DREF::URL/URN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF-STBL"><span class="nav-number">4.14.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF::STBL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF-STBL-STSD"><span class="nav-number">4.15.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF::STBL::STSD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF-STBL-STTS"><span class="nav-number">4.16.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF::STBL::STTS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF-STBL-CTTS"><span class="nav-number">4.17.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF::STBL::CTTS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF-STBL-STCO"><span class="nav-number">4.18.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF::STBL::STCO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF-STBL-STSC"><span class="nav-number">4.19.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF::STBL::STSC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MOOV-TRAK-MDIA-MINF-STBL-STSZ"><span class="nav-number">4.20.</span> <span class="nav-text">MOOV::TRAK::MDIA::MINF::STBL::STSZ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lucius</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

<div class="busuanzi-count">

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i> 访问人数<span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i> 总访问量<span class="busuanzi-value" id="busuanzi_value_site_pv"></span>次</span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'c35834931d268e5c17c6',
          clientSecret: 'c80a4f57c98a6cf8d87e0c7d306201814a0dc745',
          repo: 'lucius0.github.io',
          owner: 'lucius0',
          admin: ['lucius0'],
          id: location.pathname,
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>


  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


  <script type="text/javascript">
    (function() {
      // try {
      //   var document = window.document;
      //   document.oncontextmenu = function() {
      //     return false;
      //   }
      //   document.onkeydown = function() {
      //     if (window.event.ctrlKey && window.event.keyCode == 67) {
      //       return false;
      //     }
      //     return false;
      //   }
      //   document.body.oncopy = function() {
      //     return false;
      //   }
      //   document.onselectstart = function() {
      //     return false;
      //   }
            
      //   document.onselectstart=function(){return false};
      //   // document.style.MozUserSelect && document.style.MozUserSelect="none";
      //   document.onmousedown=function(){return false};
      //   document.style.cursor = "default"; 
      // } catch(e) {}
    })();
  </script>

</body>
</html>
